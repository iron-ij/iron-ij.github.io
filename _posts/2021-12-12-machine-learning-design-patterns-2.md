---
title: 머신러닝 디자인 패턴 정리 - 데이터 스케일링
date: 2021-12-12 21:59:00 +0900
categories: [머신러닝]
tags: [머신러닝, 디자인패턴]
use_math: true
---

아마 시중에 있는 머신러닝/딥러닝 책을 구매해서 땋! 하고 펴보면 제일 먼저 Mnist(손글씨) 데이터셋이 주어지고 이를 통해 머신러닝 문제들을 해결하는 예제를 쉽게 접해볼 수 있다. 

오늘 포스팅에서는 머신러닝 모델링을 진행하기 이전에 데이터 스케일링 과정은 왜 필요하며 어떤 것들이 있는지 살펴보고 책에 나와있는 내용 이외에 머신러닝 서비스를 염두할 때 고려해야할 점을 가볍게 정리해보고자 한다.

# #1 스케일링은 왜 필요할까?

---

1. 경사하강법을 쓰는 경우에 더 빠른 수렴을 기대해볼 수 있다.
    1. loss가 크면 클수록 `Computational cost`가 커지고, 잘못된 가중치 업데이트로 이어질 수 있음
2. [-1, 1]로 스케일링을 하면 가장 높은 부동 소수점 정밀도를 얻을 수 있다.
3. **특정 머신러닝 알고리즘에 경우, 서로 다른 Feature의 상대 크기에 매우 민감하다**
    1. 유클리드 거리를 기준으로 업데이트 하는 경우, 예컨데 k-means같은 알고리즘은 상대 크기가 큰 feature에 영향을 많이 받게 된다
    2. 모델 정규화(L1, L2)의 효율성에도 영향을 준다

→ 특히, 3번 이유가 가장 일반적인 이유인데, 머신러닝 알고리즘을 사용할 때는 스케일링을 항상 유념해야 한다.

# #2 스케일링은 어떤 방식이 있을까?

---

## 2.1 Linear scaling

데이터의 분포가 어느정도 일관된 형태이거나, 정규분포형의 데이터 분포를 보인다면 스케일링 진행시에 선형으로 스케일링하는 방법론을 고려해 볼 수 있다. 물론 앞서 예로든 형태를 띄지 않더라도 적용할 수 있지만 효과가 없을 수 있어서 별로 추천하지는 않는다. 선형으로 스케일링하는 경우에 자주 사용하는 방법론인데 크게 4가지가 있는데 같이 봐보자 (물론 더 있지만, 여기에선 자세하게 설명하지는 않겠다)

### 1) Min-Max 스케일링

- 데이터를 최소값 -1, 최대값 1로 설정하는 스케일링이다.

$$x_{scaled} = \frac{(2x -  x_{max} - x_{min})} {x_{max} - x_{min}} , x\in X$$

- 단, min / max 고려시 아웃라이어 체크를 반드시 해야한다. 대부분 raw한 데이터를 활용하는 경우에 아웃라이어가 min / max가 되는 경우가 많으며 이런 경우 모델에 영향을 주게 된다.

### 2) 클리핑

- 1차적으로 Min-Max 스케일링과 동일한 개념이지만, 전체 분포의 최대값이 아닌 `특정값`을 min/max로 활용한다. 예를 들어 최대값으로 특정한 값보다 큰 x의 경우에는 최대값과 동일하도록 설정한다.
- 특정값을 어떻게 설정해야 되는가에 물음표가 있을 수 있지만, 대부분의 경우 정답이 있지는 않다 (애도...) 그럼에도 불구하고 이런 방식을 활용하면 Min-Max 스케일링의 단점인 아웃라이어에 취약한 점에 어느정도 효과를 볼 수 있다.

### 3)Z-score 정규화

- 데이터의 특성을 고려하여 정규화하는 방식으로 문제를 해결하는 방식이며, 대부분에 경우에서 좋은 성과를 발휘하고 데이터에 대한 사전 지식이 없더라도 아웃라이어를 해결 할 수 있다

$$x_{scaled} = \frac{x-\mu}{\sigma}$$

- 이때, $\mu$는 x가 속한 분포의 평균이며, $\sigma$는 x가 속한 분포의 표준편차이다.

### 4)윈저라이징

- 학습 데이터의 경험적 분포를 사용하여 데이터값의 10분위 및 90분위수(or 5분위 및 95분위수 등)에 해당 하는 경계로 데이터셋을 클리핑 한다. 역시 단순 min/max 표준화에 비해서 아웃라이어를 어느정도 해결할 수 있다.
- 사이킷런에서는 RobustScaler를 참고해볼만 하다. RobustScaler는 기본적으로 Q1 / Q3을 기준으로 윈저라이징한다고 보면 될 것 같다.

이외에는 절대값을 취한 후 Min-Max 스케일링을 진행하는 방법 등이 있다.

## 2.2 Nonlinear scaling

데이터 자체가 굉장히 치우쳐 있거나, 우리가 익히 아는 정규분포형 데이터를 띄지 않는 경우에 우선적으로 고려해 볼만한 방법이다. 간단하게 몇가지만 소개하자면 1) 로그변환(데이터 값에 로그를 취함), 2) 시그모이드 함수 적용, 3) 다항식 전개, 4) 박스콕스변환, 5) 버켓 등이 있다

- 개인적으로는 다항식 전개는 데이터 구조에 대한 이해가 깊지 않다면 쓰기 어려운 방법론이라 생각해서 분포에 대한 이해도가 높은 경우를 빼고는 실무에서 머신러닝 사용하면서 사용한 케이스가 많이 없다.
- 박스콕스 변환은 이분산성을 제어하는 하는데 효과적이다.
- 개인적으로는 실무에서는 로그변환, 버켓을 주로 활용한다.

# #3 머신러닝을 서비스에 적용할 때 고려할 부분

---

## 1. Min-max 스케일러를 활용할때는 새로운 데이터에 주의하자

모델을 배포해서 새롭게 데이터가 들어오는 상황을 가정해보자. 그런데 새로운 데이터가 이전에는 없던 Min-max 값을 보이고 있는 경우 모델자체가 흔들릴 수 있다. 배포 이후 들어오게 되는 데이터의 수준이 가늠되지 않는다면 클리핑 / 윈저라이저 등을 활용해서 해결하는 방법이 일반적이고, Z-score 정규화로 변경하는 것 또한 대안이 될 수 있다.

## 2. 아웃라이어를 버리지 말자

흔히 아웃라이어(이상치)로 분류되는 값들을 머신러닝 모델링에서 **버리고** 진행하는 케이스를 자주 보게된다. 그런데 실제로 서비스에 적용하고자 할 때는 리스크가 있을 수 있다. 

광고 페이지의 클릭율을 input 데이터로 활용해서 모델링을 진행한다고 가정할 때, 5%의 클릭율을 Max 클리핑하게되면 5%이상인 케이스가 발생할 때 모델이 적절하게 예측할 수 없을 수 있다.

단, **잘못된 데이터는 제외**하자. 사용자의 나이 데이터를 조사하는 단계에서 `-5살`이 입력됐다면 이런 데이터는 제외하는 것이 적절하다는 것이다.

## 3. 버켓을 잘 활용하자

휴리스틱한 부분이 들어가지만, 버켓을 잘 활용해서 데이터를 구간별로 잘나누는 것도 서비스시에 도움이 되는 방법이다. 꽤 일반적으로 사용하는 방법론이지만 거창하게 다시한번 말한 것에 불가한데, 예를 들어 나이 데이터를 활용하는 경우에 5세 단위로 구분해서 한개의 그룹핑을 하는 방법 등을 활용하면 나이만 Feature로 볼 때보다 데이터의 안정성이 증가하는 경우를 확인해볼 수 있다. (일종의 대수의 법칙이랄까...)

이번 포스팅에서는 머신러닝에서 적용되는 스케일링에 종류에 대해서 다시한번 알아보고 서비스에 적용할 떄 고려할 부분에 대해서 정리해보았다. 실제 모델링 환경에서는 위 종류보다 더 어려운 상황을 만날수 있지만 대부분의 경우에는 위 케이스를 이해하고 아웃라이어에 대한 대처방법을 미리 고려하는 것만으로도 안정성을 꽤 확보할 수 있다.